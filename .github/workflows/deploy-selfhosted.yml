name: Deploy to Production (Self-Hosted)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted  # Runs on your local network runner
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production Server (LAN)
        env:
          PROD_HOST: ${{ secrets.PROD_SERVER_LAN_IP }}
          PROD_USER: ${{ secrets.PROD_SERVER_USER }}
          PROD_PASSWORD: ${{ secrets.PROD_SERVER_PASSWORD }}
        run: |
          echo "ðŸ”„ Deploying to production server via LAN..."
          
          # Use sshpass for password authentication (install if needed)
          # Alternative: Use SSH key if you can set one up on LAN
          
          sshpass -p "$PROD_PASSWORD" ssh -o StrictHostKeyChecking=no $PROD_USER@$PROD_HOST << 'ENDSSH'
            cd /opt/christmas-feedback
            
            echo "ðŸ”„ Pulling latest changes..."
            git pull origin main
            
            echo "ðŸ” Checking for available ports..."
            if [ -f check-ports.sh ]; then
              chmod +x check-ports.sh
              ./check-ports.sh
            fi
            
            echo "ðŸ³ Rebuilding and restarting containers..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
            
            echo "â³ Waiting for services to start..."
            sleep 10
            
            echo "ðŸ“Š Running database migrations..."
            docker exec christmas-feedback-app npx prisma migrate deploy
            
            echo "âœ… Checking deployment status..."
            docker ps | grep christmas-feedback
            
            echo "ðŸŽ„ Deployment complete!"
          ENDSSH

      - name: Deployment Status
        if: success()
        run: |
          echo "âœ… Successfully deployed to production!"
          echo "ðŸŒ Access at: http://112.198.194.104"
          
      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for errors."
