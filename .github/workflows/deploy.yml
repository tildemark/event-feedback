name: Deploy to Production (DISABLED - SSH Restricted)

# This workflow is disabled because the production server restricts SSH from external sources
# Use deploy-selfhosted.yml with a self-hosted runner instead
# Or use the manual deployment script: deploy-manual.ps1

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          password: ${{ secrets.PROD_SERVER_PASSWORD }}
          port: ${{ secrets.PROD_SERVER_PORT }}
          script: |
            cd /opt/christmas-feedback
            
            echo "üîÑ Pulling latest changes..."
            git pull origin main
            
            echo "üîç Checking for available ports..."
            if [ -f check-ports.sh ]; then
              chmod +x check-ports.sh
              ./check-ports.sh
            fi
            
            echo "üê≥ Rebuilding and restarting containers..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d --build
            
            echo "‚è≥ Waiting for services to start..."
            sleep 10
            
            echo "üìä Running database migrations..."
            docker exec christmas-feedback-app npx prisma migrate deploy
            
            echo "‚úÖ Checking deployment status..."
            docker ps | grep christmas-feedback
            
            echo "üéÑ Deployment complete!"
            
            # Test the application
            APP_PORT=$(grep APP_PORT .env.production | cut -d '=' -f2)
            curl -f http://localhost:${APP_PORT:-3001} || echo "‚ö†Ô∏è App might still be starting..."

      - name: Deployment Status
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to production!"
          echo "üåê Access at: http://112.198.194.104"
          
      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs above for errors."
